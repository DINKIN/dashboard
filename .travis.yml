osx_image: xcode7.3

language:
- ruby

matrix:
  include:
  - os: linux
    env: CC=clang CXX=clang++ npm_config_clang=1
    compiler: clang
  - os: osx

env:
  global:
  - NODE_VERSION=5

cache:
  directories:
  - node_modules
  - app/node_modules
  - "$HOME/.electron"
  - "$HOME/.npm"

addons:
  apt:
    sources:
    - ubuntu-toolchain-r-test
    - llvm-toolchain-precise-3.7
    packages:
    - libgnome-keyring-dev
    - icnsutils
    - clang-3.7

before_install:
- if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew update ; fi
- if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew install git-lfs; fi
- if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then git lfs pull; fi
- gem install --no-rdoc --no-ri fpm

install:
- nvm install $NODE_VERSION
- npm install npm -g
- npm prune
- npm install

script:
- npm test
- npm run dist
- find ./dist
branches:
  except:
  - "/^v\\d+\\.\\d+\\.\\d+$/"

deploy:
  provider: releases
  api_key:
    secure: r/v4o1xMg0SpCxnFcYPdzD3UgnCbr8yofkp5jY2JKqX/b4V0HCsJn6bN5KBLOadsiLDI7oUtEefsiI57G3ivZtfEM1IUQDpeGTVEyGzE6zFcRlV8WR484QCuvh16xt2XZbhPVdzePdEZdlP7f9/C09ms4KQOxpElsiPiLNSF1CWcxbvOItMYHgPR8ydyZyiSthsg/ORQWkY2Dg+RipYMHBWBhOMrMlEIzLGua6TgaFCBvcJjfq1MYyLCJf4ZjbWUDhnN8yQd8920gXB6fXf6dpPwrFdWpxaWE0NiDEBMtc2OzDXFtiKYWOwcTVcSZsIE7XYk3X37d8QkADh9WgBdv2OvwPX1CQd/PPvQ9dREsIDpXRNIfL+qbCVR0kO6m0JHkvpQBzUvpqlx0G2YQVBHft67WoZHOgaXoPybpruSQf0XRdKBdAt5UdSz4OzsF5TcndcsZWsj+WyYGvhzOa4KuDDfRpRc3sZJx2u6Htx/GdBAbQs7tHE4DpBAxiie2C80XAvX2mrBFS2nKYrsAZKIRsRL+HJGY8QgAs3j8JHVDJu2ht4EwM/ZzoEwST2wJ0vFS1GXMTAnb8fRC+2XDfJkmej7wLfKYIFPC2SzGHaZD2qrGCHjBU8KpeshpJY8YJcbwofJUgMMUAPVe/EfzlNmPnjmy3qXUFuma8/h0YEDpg4=
  file: dist/**/*.dmg
  on:
    repo: nodecg/dashboard
